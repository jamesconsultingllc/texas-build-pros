name: Azure Static Web Apps CI/CD

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - develop
      - 'release/**'
      - 'feature/**'
      - 'hotfix/**'
  pull_request:
    types: [closed]
    branches:
      - main
      - develop
      - 'release/**'

permissions:
  id-token: write
  contents: read

jobs:
  build_and_deploy_job:
    if: github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    name: Build and Deploy Job
    environment: ${{ github.ref == 'refs/heads/main' && 'production' || github.ref == 'refs/heads/develop' && 'development' || 'preview' }}
    steps:
      - uses: actions/checkout@eef61447b9ff4aafe5dcd4e0bbf5d482be7e7871 # v4.2.1
        with:
          submodules: true
          lfs: false
          fetch-depth: 0

      - name: Determine Source Environment
        id: source-env
        shell: bash
        run: |
          branch="${{ github.ref_name }}"
          
          if [[ "$branch" == feature/* ]] || [[ "$branch" == hotfix/* ]]; then
            parent_commit=$(git merge-base HEAD origin/develop 2>/dev/null || git merge-base HEAD origin/main 2>/dev/null || echo "")
            
            if [[ -n "$parent_commit" ]]; then
              if git merge-base --is-ancestor "$parent_commit" origin/develop 2>/dev/null; then
                echo "source=develop" >> "$GITHUB_OUTPUT"
                echo "source_env=development" >> "$GITHUB_OUTPUT"
              else
                echo "source=main" >> "$GITHUB_OUTPUT"
                echo "source_env=production" >> "$GITHUB_OUTPUT"
              fi
            else
              echo "source=develop" >> "$GITHUB_OUTPUT"
              echo "source_env=development" >> "$GITHUB_OUTPUT"
            fi
          elif [[ "$branch" == release/* ]]; then
            echo "source=develop" >> "$GITHUB_OUTPUT"
            echo "source_env=development" >> "$GITHUB_OUTPUT"
          else
            echo "source=none" >> "$GITHUB_OUTPUT"
            echo "source_env=none" >> "$GITHUB_OUTPUT"
          fi

      - name: Determine Deployment Slot
        id: resolve-env
        shell: bash
        env:
          REF_NAME: ${{ github.ref_name }}
        run: |
          branch="${REF_NAME}"
          
          if [[ "$branch" == "main" ]]; then
            echo "environment=Production" >> "$GITHUB_OUTPUT"
            echo "slot=" >> "$GITHUB_OUTPUT"
          elif [[ "$branch" == "develop" ]]; then
            echo "environment=Development" >> "$GITHUB_OUTPUT"
            echo "slot=development" >> "$GITHUB_OUTPUT"
          elif [[ "$branch" == release/* ]]; then
            echo "environment=Staging" >> "$GITHUB_OUTPUT"
            echo "slot=staging" >> "$GITHUB_OUTPUT"
          elif [[ "$branch" == feature/* ]] || [[ "$branch" == hotfix/* ]]; then
            # SWA removes all non-alphanumeric characters and truncates
            sanitized_branch=$(echo "$branch" | sed 's/[^a-zA-Z0-9]//g' | cut -c1-20 | tr '[:upper:]' '[:lower:]')
            echo "environment=$sanitized_branch" >> "$GITHUB_OUTPUT"
            echo "slot=$sanitized_branch" >> "$GITHUB_OUTPUT"
          else
            sanitized_branch=$(echo "$branch" | sed 's/[^a-zA-Z0-9]//g' | cut -c1-20 | tr '[:upper:]' '[:lower:]')
            echo "environment=$sanitized_branch" >> "$GITHUB_OUTPUT"
            echo "slot=$sanitized_branch" >> "$GITHUB_OUTPUT"
          fi

      - name: Build And Deploy
        id: builddeploy
        uses: Azure/static-web-apps-deploy@1a947af9992250f3bc2e68ad0754c0b0c11566c9 # v1.0.0
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_MANGO_MEADOW_0DA95B810 }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: upload
          deployment_environment: ${{ steps.resolve-env.outputs.slot }}
          app_location: "/"
          api_location: "api"
          output_location: "dist"
          production_branch: main
        env:
          VITE_APPINSIGHTS_CONNECTION_STRING: ${{ secrets.APPLICATIONINSIGHTS_CONNECTION_STRING }}

      - name: Azure Login with OIDC
        uses: azure/login@a65d910e8af852a8061c627c456678983e180302 # v2.2.0
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Update Storage CORS for Environment
        shell: bash
        env:
          STORAGE_ACCOUNT_KEY: ${{ secrets.STORAGE_ACCOUNT_KEY }}
        run: |
          slot="${{ steps.resolve-env.outputs.slot }}"

          # Determine the SWA hostname based on deployment slot
          if [[ -z "$slot" ]] || [[ "$slot" == "" ]]; then
            # Production - main branch
            SWA_URL="https://mango-meadow-0da95b810.azurestaticapps.net"
          else
            # Preview/Dev environments
            SWA_URL="https://${slot}.mango-meadow-0da95b810.azurestaticapps.net"
          fi

          echo "Checking CORS for: $SWA_URL"

          STORAGE_ACCOUNT="legacybuildersdevst"

          if [[ -z "$STORAGE_ACCOUNT_KEY" ]]; then
            echo "Storage account key not configured in GitHub secrets"
            echo "Skipping CORS configuration"
            exit 0
          fi

          # Get current CORS rules as JSON
          CORS_RULES=$(az storage cors list \
            --account-name "$STORAGE_ACCOUNT" \
            --account-key "$STORAGE_ACCOUNT_KEY" \
            --services b \
            -o json 2>/dev/null || echo "[]")

          # Check if origin already exists in any rule
          ORIGIN_EXISTS=$(echo "$CORS_RULES" | jq -r "[.[].allowedOrigins[]] | any(. == \"$SWA_URL\")")

          if [[ "$ORIGIN_EXISTS" == "true" ]]; then
            echo "CORS rule already exists for $SWA_URL"
          else
            echo "Adding new CORS rule for $SWA_URL"

            # Count existing rules
            RULE_COUNT=$(echo "$CORS_RULES" | jq '. | length')

            if [[ $RULE_COUNT -ge 5 ]]; then
              echo "Maximum CORS rules reached. Consolidating origins into single rule..."

              # Extract all unique origins
              ALL_ORIGINS=$(echo "$CORS_RULES" | jq -r '[.[].allowedOrigins[]] | unique | join(",")')

              # Add the new origin
              if [[ -n "$ALL_ORIGINS" ]]; then
                ALL_ORIGINS="$ALL_ORIGINS,$SWA_URL"
              else
                ALL_ORIGINS="$SWA_URL"
              fi

              # Clear existing rules
              az storage cors clear \
                --account-name "$STORAGE_ACCOUNT" \
                --account-key "$STORAGE_ACCOUNT_KEY" \
                --services b

              # Add single consolidated rule with all origins
              az storage cors add \
                --account-name "$STORAGE_ACCOUNT" \
                --account-key "$STORAGE_ACCOUNT_KEY" \
                --services b \
                --methods GET PUT POST DELETE HEAD OPTIONS \
                --origins "$ALL_ORIGINS" \
                --allowed-headers "*" \
                --exposed-headers "*" \
                --max-age 3600

              echo "Consolidated all origins into single CORS rule"
            else
              # Add as new rule if under limit
              az storage cors add \
                --account-name "$STORAGE_ACCOUNT" \
                --account-key "$STORAGE_ACCOUNT_KEY" \
                --services b \
                --methods GET PUT POST DELETE HEAD OPTIONS \
                --origins "$SWA_URL" \
                --allowed-headers "*" \
                --exposed-headers "*" \
                --max-age 3600
            fi
          fi

          echo "Current CORS rules:"
          az storage cors list \
            --account-name "$STORAGE_ACCOUNT" \
            --account-key "$STORAGE_ACCOUNT_KEY" \
            --services b -o table

      - name: Copy Environment Variables from Source
        if: |
          (startsWith(github.ref, 'refs/heads/feature/') || 
           startsWith(github.ref, 'refs/heads/hotfix/') || 
           startsWith(github.ref, 'refs/heads/release/')) &&
          steps.source-env.outputs.source_env != 'none'
        shell: bash
        run: |
          source_env="${{ steps.source-env.outputs.source_env }}"
          
          echo "Finding target environment..."
          
          # List environments and find the one matching our branch pattern
          branch="${{ github.ref_name }}"
          branch_pattern=$(echo "$branch" | sed 's/[^a-zA-Z0-9]//g' | tr '[:upper:]' '[:lower:]')
          
          # Get the actual environment name from SWA
          target_slot=$(az staticwebapp environment list \
            --name legacy-builders \
            --resource-group legacy-builders \
            --query "[?starts_with(name, '${branch_pattern:0:10}')].name | [0]" -o tsv)
          
          if [[ -z "$target_slot" ]]; then
            echo "Could not find target environment matching pattern: $branch_pattern"
            echo "Available environments:"
            az staticwebapp environment list \
              --name legacy-builders \
              --resource-group legacy-builders \
              --query "[].name" -o tsv
            exit 0  # Don't fail, just skip
          fi
          
          echo "Copying settings from $source_env to $target_slot"
          
          if [[ "$source_env" == "production" ]]; then
            settings=$(az staticwebapp appsettings list \
              --name legacy-builders \
              --resource-group legacy-builders \
              --query "properties" -o json)
          else
            settings=$(az staticwebapp appsettings list \
              --name legacy-builders \
              --resource-group legacy-builders \
              --environment-name "$source_env" \
              --query "properties" -o json 2>/dev/null || echo "{}")
          fi
          
          echo "Retrieved settings: $settings"
          
          if [[ "$settings" != "{}" ]] && [[ -n "$settings" ]] && [[ "$settings" != "null" ]]; then
            settings_file="${RUNNER_TEMP}/settings.txt"
            echo "$settings" | jq -r 'to_entries[] | "\(.key)=\(.value)"' > "$settings_file"
            
            while IFS= read -r setting; do
              key="${setting%%=*}"
              value="${setting#*=}"
              
              if [[ -n "$value" ]] && [[ "$value" != "null" ]]; then
                echo "Setting $key for $target_slot"
                az staticwebapp appsettings set \
                  --name legacy-builders \
                  --resource-group legacy-builders \
                  --environment-name "$target_slot" \
                  --setting-names "$key=$value"
              fi
            done < "$settings_file"
            
            echo "Settings copied successfully"
          else
            echo "No settings found in source environment or settings are empty"
          fi

  close_pull_request_job:
    if: |
      github.event_name == 'pull_request' && 
      github.event.action == 'closed' &&
      github.event.pull_request.merged == true &&
      (startsWith(github.event.pull_request.head.ref, 'feature/') || 
       startsWith(github.event.pull_request.head.ref, 'hotfix/') ||
       (startsWith(github.event.pull_request.head.ref, 'release/') && github.event.pull_request.base.ref == 'develop'))
    runs-on: ubuntu-latest
    name: Close Preview Environment
    steps:
      - name: Azure Login with OIDC
        uses: azure/login@a65d910e8af852a8061c627c456678983e180302 # v2.2.0
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Find and Delete Environment
        id: delete-env
        shell: bash
        continue-on-error: true
        env:
          BRANCH_REF: ${{ github.event.pull_request.head.ref }}
        run: |
          branch="${BRANCH_REF}"
          branch_pattern=$(echo "$branch" | sed 's/[^a-zA-Z0-9]//g' | cut -c1-20 | tr '[:upper:]' '[:lower:]')
          
          echo "Looking for environment matching pattern: $branch_pattern"
          echo "slot=$branch_pattern" >> "$GITHUB_OUTPUT"
          
          target_slot=$(az staticwebapp environment list \
            --name legacy-builders \
            --resource-group legacy-builders \
            --query "[?starts_with(name, '${branch_pattern:0:10}')].name | [0]" -o tsv)
          
          if [[ -n "$target_slot" ]]; then
            echo "Found environment to delete: $target_slot"
            az staticwebapp environment delete \
              --name legacy-builders \
              --resource-group legacy-builders \
              --environment-name "$target_slot" \
              --yes
            echo "deleted=true" >> "$GITHUB_OUTPUT"
          else
            echo "No environment found"
            echo "deleted=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Remove Storage CORS for Preview Environment
        shell: bash
        continue-on-error: true
        env:
          STORAGE_ACCOUNT_KEY: ${{ secrets.STORAGE_ACCOUNT_KEY }}
        run: |
          slot="${{ steps.delete-env.outputs.slot }}"

          if [[ -z "$slot" ]]; then
            echo "No slot to clean up CORS for"
            exit 0
          fi

          # Construct the SWA URL that was registered
          SWA_URL="https://${slot}.mango-meadow-0da95b810.azurestaticapps.net"

          echo "Removing CORS rule for: $SWA_URL"

          STORAGE_ACCOUNT="legacybuildersdevst"

          if [[ -z "$STORAGE_ACCOUNT_KEY" ]]; then
            echo "Storage account key not configured in GitHub secrets"
            echo "Skipping CORS cleanup"
            exit 0
          fi

          # Get current CORS rules
          CORS_RULES=$(az storage cors list \
            --account-name "$STORAGE_ACCOUNT" \
            --account-key "$STORAGE_ACCOUNT_KEY" \
            --services b \
            -o json 2>/dev/null || echo "[]")

          echo "Current CORS rules: $CORS_RULES"

          # Clear all CORS rules first
          az storage cors clear \
            --account-name "$STORAGE_ACCOUNT" \
            --account-key "$STORAGE_ACCOUNT_KEY" \
            --services b

          # Re-add all rules except the one we're removing
          echo "$CORS_RULES" | jq -c '.[]' | while read -r rule; do
            origins=$(echo "$rule" | jq -r '.allowedOrigins | join(",")')

            # Skip if this rule contains the URL we want to remove
            if echo "$origins" | grep -q "$SWA_URL"; then
              echo "Skipping rule with origin: $SWA_URL"
              continue
            fi

            methods=$(echo "$rule" | jq -r '.allowedMethods | join(",")')
            allowed_headers=$(echo "$rule" | jq -r '.allowedHeaders | join(",")')
            exposed_headers=$(echo "$rule" | jq -r '.exposedHeaders | join(",")')
            max_age=$(echo "$rule" | jq -r '.maxAgeInSeconds')

            echo "Re-adding CORS rule for: $origins"
            az storage cors add \
              --account-name "$STORAGE_ACCOUNT" \
              --account-key "$STORAGE_ACCOUNT_KEY" \
              --services b \
              --methods "$methods" \
              --origins "$origins" \
              --allowed-headers "$allowed_headers" \
              --exposed-headers "$exposed_headers" \
              --max-age "$max_age"
          done

          echo "CORS cleanup complete. Remaining rules:"
          az storage cors list \
            --account-name "$STORAGE_ACCOUNT" \
            --account-key "$STORAGE_ACCOUNT_KEY" \
            --services b -o table

      - name: Fallback - Close with SWA Action
        if: steps.delete-env.outputs.deleted != 'true'
        uses: Azure/static-web-apps-deploy@1a947af9992250f3bc2e68ad0754c0b0c11566c9 # v1.0.0
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_MANGO_MEADOW_0DA95B810 }}
          action: close