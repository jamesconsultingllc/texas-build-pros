name: Azure Static Web Apps CI/CD

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - develop
      - 'release/**'
      - 'feature/**'
      - 'hotfix/**'
    paths:
      - 'src/**'
      - 'api/**'
      - 'public/**'
      - 'index.html'
      - 'package.json'
      - 'package-lock.json'
      - 'vite.config.ts'
      - 'tsconfig*.json'
      - 'staticwebapp.config.json'
  pull_request:
    types: [closed]
    branches:
      - main
      - develop
      - 'release/**'

permissions:
  id-token: write
  contents: read

jobs:
  unit_tests_job:
    if: github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    name: Unit Tests
    steps:
      - uses: actions/checkout@eef61447b9ff4aafe5dcd4e0bbf5d482be7e7871 # v4.2.1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests
        run: npm run test:unit

  build_and_deploy_job:
    if: github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    name: Build and Deploy Job
    needs: unit_tests_job
    environment: ${{ github.ref == 'refs/heads/main' && 'production' || github.ref == 'refs/heads/develop' && 'development' || 'preview' }}
    steps:
      - uses: actions/checkout@eef61447b9ff4aafe5dcd4e0bbf5d482be7e7871 # v4.2.1
        with:
          submodules: true
          lfs: false
          fetch-depth: 0

      - name: Resolve Environment
        id: resolve-env
        uses: jamesconsultingllc/resolve-swa-environment-action@f05fd14e40a2714db885a3d7aa4b7aa5c41f3d5b # v1

      - name: Build And Deploy
        id: builddeploy
        uses: Azure/static-web-apps-deploy@1a947af9992250f3bc2e68ad0754c0b0c11566c9 # v1.0.0
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_MANGO_MEADOW_0DA95B810 }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: upload
          deployment_environment: ${{ steps.resolve-env.outputs.target-slot }}
          app_location: "/"
          api_location: "api"
          output_location: "dist"
          production_branch: main
        env:
          VITE_APPINSIGHTS_CONNECTION_STRING: ${{ secrets.APPLICATIONINSIGHTS_CONNECTION_STRING }}

      - name: Azure Login with OIDC
        if: steps.resolve-env.outputs.is-preview == 'true'
        uses: azure/login@a65d910e8af852a8061c627c456678983e180302 # v2.2.0
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Add Storage CORS for Preview Environment
        if: steps.resolve-env.outputs.is-preview == 'true'
        uses: jamesconsultingllc/manage-storage-cors-action@9f8436b1ef7625f81e621a0ebe6546808f68c7be # v1.0.2
        with:
          action: add
          storage-account: legacybuildersdevst
          storage-account-key: ${{ secrets.STORAGE_ACCOUNT_KEY }}
          origin: https://${{ steps.resolve-env.outputs.target-slot }}.mango-meadow-0da95b810.azurestaticapps.net

      - name: Copy Environment Variables from Source
        if: steps.resolve-env.outputs.is-preview == 'true'
        uses: jamesconsultingllc/sync-swa-settings-action@fb31db1767b3bcc45f546e8b310372079f29cd88 # v1
        with:
          swa-name: legacy-builders
          resource-group: legacy-builders
          source-environment: ${{ steps.resolve-env.outputs.source-environment }}
          target-environment: ${{ steps.resolve-env.outputs.target-environment }}
          direction: one-way
          overwrite: 'true'
    outputs:
      deployed-url: ${{ steps.builddeploy.outputs.static_web_app_url }}

  e2e_tests_job:
    if: github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    name: E2E Tests
    needs: build_and_deploy_job
    steps:
      - uses: actions/checkout@eef61447b9ff4aafe5dcd4e0bbf5d482be7e7871 # v4.2.1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install chromium

      - name: Wait for deployment to stabilize
        run: sleep 30

      - name: Run E2E Smoke Tests
        run: npm run test:smoke
        env:
          CI: true
          HEADLESS: true
          BASE_URL: ${{ needs.build_and_deploy_job.outputs.deployed-url }}

      - name: Run Accessibility Tests
        run: npm run test:a11y
        env:
          CI: true
          HEADLESS: true
          BASE_URL: ${{ needs.build_and_deploy_job.outputs.deployed-url }}

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results
          path: reports/
          if-no-files-found: warn
          retention-days: 7

  close_pull_request_job:
    if: |
      github.event_name == 'pull_request' && 
      github.event.action == 'closed' &&
      github.event.pull_request.merged == true &&
      (startsWith(github.event.pull_request.head.ref, 'feature/') || 
       startsWith(github.event.pull_request.head.ref, 'hotfix/') ||
       (startsWith(github.event.pull_request.head.ref, 'release/') && github.event.pull_request.base.ref == 'develop'))
    runs-on: ubuntu-latest
    name: Close Preview Environment
    steps:
      - name: Checkout
        uses: actions/checkout@eef61447b9ff4aafe5dcd4e0bbf5d482be7e7871 # v4.2.1

      - name: Resolve Source Environment (PR head branch)
        id: source-env
        uses: jamesconsultingllc/resolve-swa-environment-action@f05fd14e40a2714db885a3d7aa4b7aa5c41f3d5b # v1
        with:
          branch: ${{ github.event.pull_request.head.ref }}

      - name: Resolve Target Environment (PR base branch)
        id: target-env
        uses: jamesconsultingllc/resolve-swa-environment-action@f05fd14e40a2714db885a3d7aa4b7aa5c41f3d5b # v1
        with:
          branch: ${{ github.event.pull_request.base.ref }}
          detect-source: 'false'

      - name: Azure Login with OIDC
        uses: azure/login@a65d910e8af852a8061c627c456678983e180302 # v2.2.0
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Find Source Slot in SWA
        id: find-slot
        shell: bash
        run: |
          slot_pattern="${{ steps.source-env.outputs.sanitized-branch }}"
          
          echo "Looking for environment matching pattern: $slot_pattern"
          
          source_slot=$(az staticwebapp environment list \
            --name legacy-builders \
            --resource-group legacy-builders \
            --query "[?starts_with(name, '${slot_pattern:0:10}')].name | [0]" -o tsv)
          
          if [[ -n "$source_slot" ]]; then
            echo "Found source environment: $source_slot"
            echo "slot=$source_slot" >> "$GITHUB_OUTPUT"
            echo "found=true" >> "$GITHUB_OUTPUT"
          else
            echo "No environment found"
            echo "slot=" >> "$GITHUB_OUTPUT"
            echo "found=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Sync New Settings to Target
        if: steps.find-slot.outputs.found == 'true'
        uses: jamesconsultingllc/sync-swa-settings-action@fb31db1767b3bcc45f546e8b310372079f29cd88 # v1
        with:
          swa-name: legacy-builders
          resource-group: legacy-builders
          source-environment: ${{ steps.find-slot.outputs.slot }}
          target-environment: ${{ steps.target-env.outputs.target-environment }}

      - name: Delete Preview Environment
        id: delete-env
        if: steps.find-slot.outputs.found == 'true'
        shell: bash
        continue-on-error: true
        run: |
          source_slot="${{ steps.find-slot.outputs.slot }}"
          
          echo "Deleting environment: $source_slot"
          az staticwebapp environment delete \
            --name legacy-builders \
            --resource-group legacy-builders \
            --environment-name "$source_slot" \
            --yes
          echo "deleted=true" >> "$GITHUB_OUTPUT"

      - name: Remove Storage CORS for Preview Environment
        if: steps.find-slot.outputs.found == 'true'
        uses: jamesconsultingllc/manage-storage-cors-action@9f8436b1ef7625f81e621a0ebe6546808f68c7be # v1.0.2
        with:
          action: remove
          storage-account: legacybuildersdevst
          storage-account-key: ${{ secrets.STORAGE_ACCOUNT_KEY }}
          origin: https://${{ steps.find-slot.outputs.slot }}.mango-meadow-0da95b810.azurestaticapps.net

      - name: Fallback - Close with SWA Action
        if: steps.find-slot.outputs.found != 'true'
        uses: Azure/static-web-apps-deploy@1a947af9992250f3bc2e68ad0754c0b0c11566c9 # v1.0.0
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_MANGO_MEADOW_0DA95B810 }}
          action: close